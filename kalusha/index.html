<!-- This is a static file -->
<!-- served from your routes in server.js -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Primary Meta Tags -->
  <title>Slowed + Reverb</title>
  <meta name="title" content="Slowed + Reverb">
  <meta name="description" content="Generative Slowcore.">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="">
  <meta property="og:title" content="Slowed + Reverb">
  <meta property="og:description" content="Generative Slowcore.">
  <meta property="og:image" content="">

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="og:url" content="">
  <meta property="twitter:title" content="Slowed + Reverb">
  <meta property="twitter:description" content="Generative Slowcore.">
  <meta property="twitter:image" content="">

  <!-- CSS -->
  <link rel="stylesheet" type="text/css" href="https://dpalmer.in/Peoria/css/normalize.css">
  <link rel="stylesheet" type="text/css" href="https://dpalmer.in/Peoria/css/peoria-0-4-4.css">
</head>

<body class="night">
  <div class="container mt-1">
    <h1 class="my-1 text-c title-3">Huesos</h1>
    <audio src="./bass.mp3" type="audio/mpeg"></audio>
    <audio src="./guitars.mp3" id="vis" type="audio/mpeg"></audio>
    <audio src="./delay.mp3" type="audio/mpeg"></audio>
    <audio src="./drums.mp3" type="audio/mpeg"></audio>
    <audio src="./reverb.mp3" type="audio/mpeg"></audio>
    <audio src="./vocals.mp3" type="audio/mpeg"></audio>
    <audio src="./ambience.mp3" type="audio/mpeg"></audio>
  </div>

  <canvas id="output" class="center-a" height="500px" width="500px"></canvas>

  <script>
    var AudioContext = window.AudioContext || window.webkitAudioContext;
    var audioCtx = new AudioContext();

    let canvas = document.getElementById("output");
    let ctx = canvas.getContext('2d');
    
    let analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    let data = new Uint8Array(analyser.frequencyBinCount);
  
    document.querySelectorAll('audio').forEach(audio => {
      audio.addEventListener('ended', function () {
        this.currentTime = 0;
        this.play();
      }, false);
      audio.onplay = () => {
        audioCtx.resume()
      };
      audio.preservesPitch = false;

      var audioStr = audioCtx.createMediaElementSource(audio);
      audioStr.connect(analyser);
      audioStr.connect(audioCtx.destination);

      audio.play();
    });

    requestAnimationFrame(loopingFunction);

    function loopingFunction() {
      requestAnimationFrame(loopingFunction);
      analyser.getByteFrequencyData(data);
      draw(data);
    }

    function draw(data){
      data = [...data];
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      let space = canvas.width / data.length;
      data.forEach((value, i) => {
        ctx.beginPath();
        ctx.moveTo(space * i, 0);
        ctx.lineTo(space * i, canvas.height * (value/512));
        ctx.strokeStyle = "white";
        ctx.stroke();
      })
    }

    function change() {
      document.querySelectorAll('audio').forEach(audio => {
        audio.playbackRate = Math.random() * (.10) + 0.95;
      });
    }

    change()
    setInterval(change, 10000);
  </script>
</body>

</html>